#==============================================================================
# Playbook 03: Join Worker Nodes
#==============================================================================
# Joins worker nodes to the Kubernetes cluster using the join command
# generated during cluster initialization.
#
# Run: ansible-playbook -i inventory/hosts.ini playbooks/03-join-workers.yml
#==============================================================================
---
- name: Get join command from master
  hosts: master
  become: yes
  gather_facts: no
  tags:
    - join
    - workers

  tasks:
    - name: Get kubeadm join command
      command: kubeadm token create --print-join-command
      register: join_command
      changed_when: false

    - name: Set join command fact for workers
      set_fact:
        kubeadm_join_command: "{{ join_command.stdout }}"

#------------------------------------------------------------------------------
# Join workers to cluster
#------------------------------------------------------------------------------
- name: Join worker nodes to cluster
  hosts: workers
  become: yes
  gather_facts: yes
  serial: 1  # Join one node at a time
  tags:
    - join
    - workers

  tasks:
    - name: Check if node is already joined
      stat:
        path: /etc/kubernetes/kubelet.conf
      register: kubelet_conf

    - name: Display join status
      debug:
        msg: "Worker {{ inventory_hostname }} is {{ 'already joined' if kubelet_conf.stat.exists else 'not joined' }}"

    - name: Join worker to cluster
      command: "{{ hostvars[groups['master'][0]]['kubeadm_join_command'] }}"
      register: join_output
      when: not kubelet_conf.stat.exists
      timeout: 300

    - name: Display join output
      debug:
        var: join_output.stdout_lines
      when: join_output is changed

    - name: Wait for kubelet to be ready
      systemd:
        name: kubelet
        state: started
        enabled: yes

#------------------------------------------------------------------------------
# Verify all nodes joined
#------------------------------------------------------------------------------
- name: Verify cluster nodes
  hosts: master
  become: no
  become_user: ubuntu
  gather_facts: no
  tags:
    - verify

  tasks:
    - name: Wait for all nodes to be registered
      command: kubectl get nodes -o wide
      environment:
        KUBECONFIG: /home/ubuntu/.kube/config
      register: nodes_output
      until: nodes_output.stdout_lines | length >= (groups['workers'] | length + 1)
      retries: 30
      delay: 10
      changed_when: false

    - name: Display cluster nodes
      debug:
        msg: |
          Cluster Nodes:
          {{ nodes_output.stdout }}

    - name: Count nodes
      debug:
        msg: "Total nodes in cluster: {{ nodes_output.stdout_lines | length - 1 }} (expected: {{ groups['workers'] | length + 1 }})"
